<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kitchen Stock Manager</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          },
        }
      }
    }
</script>
<style>
    body {
        font-family: 'Inter', sans-serif;
        background-color: #f3f4f6;
    }
    .page {
        display: none;
    }
    .active-page {
        display: block;
    }
    .audit-log {
        max-height: 200px; /* Increased height for better visibility */
    }
</style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

<!-- Navigation Bar -->
<nav class="bg-white shadow-md p-4 sticky top-0 z-50">
  <div class="container mx-auto flex flex-col sm:flex-row justify-between items-center">
    <h1 class="text-2xl font-bold text-gray-800 mb-2 sm:mb-0">Kitchen Stock Manager</h1>
    <div class="flex flex-wrap justify-center gap-2 sm:gap-4 text-sm font-medium">
      <a href="#" onclick="showPage('home')" class="text-gray-600 hover:text-blue-600 transition duration-300">Home</a>
      <a href="#" onclick="showPage('yummyCo')" class="text-gray-600 hover:text-blue-600 transition duration-300">Yummy Co Recipes</a>
      <a href="#" onclick="showPage('keFi')" class="text-gray-600 hover:text-blue-600 transition duration-300">Ke-fi Recipes</a>
      <a href="#" onclick="showPage('yummyFrail')" class="text-gray-600 hover:text-blue-600 transition duration-300">Yummy Frail Recipes</a>
    </div>
  </div>
</nav>

<!-- Main Container -->
<main class="container mx-auto p-4 flex-grow">

    <!-- Custom Message Modal -->
    <div id="messageModal" class="fixed inset-0 z-[100] bg-gray-600 bg-opacity-75 hidden flex items-center justify-center">
      <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
        <div id="modalContent" class="text-center font-medium"></div>
        <div class="flex justify-center mt-4">
          <button onclick="hideMessage()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition duration-300">OK</button>
        </div>
      </div>
    </div>

    <!-- Page 1: Home/Dashboard -->
    <div id="home" class="page active-page">
        <div class="bg-white p-6 rounded-xl shadow-lg mt-6">
            <h2 class="text-2xl font-semibold text-center text-gray-700 mb-4">Stock Overview</h2>
            <div class="flex flex-wrap justify-center gap-6 mt-6" id="kitchens"></div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-lg mt-6 max-w-2xl mx-auto">
            <h3 class="text-xl font-semibold text-gray-700 mb-4 text-center">Transfer Stock</h3>
            <div class="flex flex-wrap justify-center items-center gap-4">
                <div class="flex flex-col items-center">
                    <label class="text-gray-600 font-medium">Item</label>
                    <select id="item" class="p-2 border rounded-md focus:ring-2 focus:ring-blue-500 transition duration-200"></select>
                </div>
                <div class="flex flex-col items-center">
                    <label class="text-gray-600 font-medium">From</label>
                    <select id="from" class="p-2 border rounded-md focus:ring-2 focus:ring-blue-500 transition duration-200">
                        <option value="yummyCo">Yummy Co</option>
                        <option value="keFi">Ke-fi</option>
                        <option value="yummyFrail">Yummy Frail</option>
                    </select>
                </div>
                <div class="flex flex-col items-center">
                    <label class="text-gray-600 font-medium">To</label>
                    <select id="to" class="p-2 border rounded-md focus:ring-2 focus:ring-blue-500 transition duration-200">
                        <option value="yummyCo">Yummy Co</option>
                        <option value="keFi">Ke-fi</option>
                        <option value="yummyFrail">Yummy Frail</option>
                    </select>
                </div>
                <div class="flex flex-col items-center">
                    <label class="text-gray-600 font-medium">Qty</label>
                    <input type="number" id="quantity" value="1" min="1" class="p-2 border rounded-md w-20 text-center focus:ring-2 focus:ring-blue-500 transition duration-200">
                </div>
                <button onclick="transferStock()" class="bg-blue-600 text-white font-medium px-6 py-2 rounded-md hover:bg-blue-700 transition duration-300 mt-4 sm:mt-0 shadow-lg">Transfer</button>
            </div>
        </div>
        
        <div class="bg-white p-6 rounded-xl shadow-lg mt-6 max-w-2xl mx-auto">
            <h3 class="text-xl font-semibold text-gray-700 mb-4 text-center">Issue Stock</h3>
            <div class="flex flex-wrap justify-center items-center gap-4">
                <div class="flex flex-col items-center">
                    <label class="text-gray-600 font-medium">Item</label>
                    <select id="issueItem" class="p-2 border rounded-md focus:ring-2 focus:ring-red-500 transition duration-200"></select>
                </div>
                <div class="flex flex-col items-center">
                    <label class="text-gray-600 font-medium">From Kitchen</label>
                    <select id="issueFrom" class="p-2 border rounded-md focus:ring-2 focus:ring-red-500 transition duration-200">
                        <option value="yummyCo">Yummy Co</option>
                        <option value="keFi">Ke-fi</option>
                        <option value="yummyFrail">Yummy Frail</option>
                    </select>
                </div>
                <div class="flex flex-col items-center">
                    <label class="text-gray-600 font-medium">Qty</label>
                    <input type="number" id="issueQuantity" value="1" min="1" class="p-2 border rounded-md w-20 text-center focus:ring-2 focus:ring-red-500 transition duration-200">
                </div>
                <div class="flex flex-col items-center">
                    <label class="text-gray-600 font-medium">Invoice No. (Optional)</label>
                    <input type="text" id="issueInvoice" placeholder="INV-001" class="p-2 border rounded-md focus:ring-2 focus:ring-red-500 transition duration-200">
                </div>
                <button onclick="issueStock()" class="bg-red-600 text-white font-medium px-6 py-2 rounded-md hover:bg-red-700 transition duration-300 mt-4 sm:mt-0 shadow-lg">Issue</button>
            </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-lg mt-6 max-w-2xl mx-auto">
            <h3 class="text-xl font-semibold text-gray-700 mb-4 text-center">Stock Issued Reports</h3>
            <div class="flex justify-center items-center gap-4 mb-4">
                <select id="reportPeriod" class="p-2 border rounded-md focus:ring-2 focus:ring-blue-500 transition duration-200">
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                </select>
                <button onclick="generateIssuedReport()" class="bg-blue-600 text-white font-medium px-6 py-2 rounded-md hover:bg-blue-700 transition duration-300 shadow-lg">Generate Report</button>
            </div>
            <div id="issuedReport" class="bg-gray-50 max-h-60 overflow-y-auto border border-gray-300 rounded-md p-2 hidden"></div>
        </div>
        
        <div id="adminPanel" class="bg-white p-6 rounded-xl shadow-lg mt-6 max-w-2xl mx-auto hidden">
            <h3 class="text-xl font-semibold text-gray-700 mb-4 text-center">Admin Panel</h3>
            <div class="flex flex-col sm:flex-row justify-center items-center gap-4 mb-4">
                <div class="flex flex-col">
                    <label class="text-gray-600 font-medium">Item Name</label>
                    <input type="text" id="newItemName" placeholder="e.g., Tomatoes" class="p-2 border rounded-md focus:ring-2 focus:ring-blue-500 transition duration-200">
                </div>
                 <div class="flex flex-col">
                    <label class="text-gray-600 font-medium">Price (R)</label>
                    <input type="number" step="0.01" id="newItemPrice" value="1.00" min="0" class="p-2 border rounded-md w-24 text-center focus:ring-2 focus:ring-blue-500 transition duration-200">
                </div>
                <div class="flex flex-col">
                    <label class="text-gray-600 font-medium">Quantity</label>
                    <input type="number" id="newItemQty" value="1" min="1" class="p-2 border rounded-md w-24 text-center focus:ring-2 focus:ring-blue-500 transition duration-200">
                </div>
                 <div class="flex flex-col">
                    <label class="text-gray-600 font-medium">Invoice No. (Optional)</label>
                    <input type="text" id="newItemInvoice" placeholder="INV-001" class="p-2 border rounded-md w-24 text-center focus:ring-2 focus:ring-blue-500 transition duration-200">
                </div>
                <div class="flex flex-col">
                    <label class="text-gray-600 font-medium">Kitchen</label>
                    <select id="newItemKitchen" class="p-2 border rounded-md focus:ring-2 focus:ring-blue-500 transition duration-200">
                        <option value="yummyCo">Yummy Co</option>
                        <option value="keFi">Ke-fi</option>
                        <option value="yummyFrail">Yummy Frail</option>
                    </select>
                </div>
                <button onclick="addItem()" class="bg-green-600 text-white font-medium px-6 py-2 rounded-md hover:bg-green-700 transition duration-300 mt-4 sm:mt-0 shadow-lg">Add Item</button>
            </div>
            <div class="flex justify-center items-center gap-4 mt-4">
                <button onclick="resetStock()" class="bg-red-600 text-white font-medium px-6 py-2 rounded-md hover:bg-red-700 transition duration-300 shadow-lg">Reset Stock</button>
            </div>
            <div class="mt-6">
                <h4 class="text-lg font-medium text-gray-700 mb-2">Audit Log</h4>
                <div class="audit-log bg-gray-50 max-h-40 overflow-y-auto border border-gray-300 rounded-md p-2" id="auditLog"></div>
            </div>
        </div>
        <div class="flex justify-center mt-6">
            <button onclick="loginAdmin()" class="bg-gray-600 text-white font-medium px-6 py-2 rounded-md hover:bg-gray-700 transition duration-300 shadow-lg">Admin Login</button>
        </div>
    </div>

    <!-- Page 2: Yummy Co Recipes -->
    <div id="yummyCo" class="page">
        <h2 class="text-2xl font-semibold text-center text-gray-700 mb-4 mt-6">Yummy Co Recipes</h2>
        <div class="bg-white p-6 rounded-xl shadow-lg mt-4 max-w-2xl mx-auto">
            <h3 class="text-xl font-semibold text-gray-700 mb-4 text-center">Add New Recipe</h3>
            <div class="flex flex-col gap-4">
                <input type="text" id="yummyCoRecipeName" placeholder="Recipe Name" class="p-2 border rounded-md focus:ring-2 focus:ring-blue-500 transition duration-200">
                <textarea id="yummyCoRecipeIngredients" rows="3" placeholder="Ingredients (e.g., Apples:2, Bananas:1)" class="p-2 border rounded-md focus:ring-2 focus:ring-blue-500 transition duration-200"></textarea>
                <button onclick="addRecipe('yummyCo')" class="bg-blue-600 text-white font-medium px-6 py-2 rounded-md hover:bg-blue-700 transition duration-300 shadow-lg">Add Recipe</button>
            </div>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-lg mt-6 max-w-2xl mx-auto">
            <h3 class="text-xl font-semibold text-gray-700 mb-4 text-center">Available Recipes</h3>
            <div id="yummyCoRecipes" class="flex flex-col gap-4"></div>
        </div>
    </div>

    <!-- Page 3: Ke-fi Recipes -->
    <div id="keFi" class="page">
        <h2 class="text-2xl font-semibold text-center text-gray-700 mb-4 mt-6">Ke-fi Recipes</h2>
        <div class="bg-white p-6 rounded-xl shadow-lg mt-4 max-w-2xl mx-auto">
            <h3 class="text-xl font-semibold text-gray-700 mb-4 text-center">Add New Recipe</h3>
            <div class="flex flex-col gap-4">
                <input type="text" id="keFiRecipeName" placeholder="Recipe Name" class="p-2 border rounded-md focus:ring-2 focus:ring-blue-500 transition duration-200">
                <textarea id="keFiRecipeIngredients" rows="3" placeholder="Ingredients (e.g., Apples:2, Bananas:1)" class="p-2 border rounded-md focus:ring-2 focus:ring-blue-500 transition duration-200"></textarea>
                <button onclick="addRecipe('keFi')" class="bg-blue-600 text-white font-medium px-6 py-2 rounded-md hover:bg-blue-700 transition duration-300 shadow-lg">Add Recipe</button>
            </div>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-lg mt-6 max-w-2xl mx-auto">
            <h3 class="text-xl font-semibold text-gray-700 mb-4 text-center">Available Recipes</h3>
            <div id="keFiRecipes" class="flex flex-col gap-4"></div>
        </div>
    </div>

    <!-- Page 4: Yummy Frail Recipes -->
    <div id="yummyFrail" class="page">
        <h2 class="text-2xl font-semibold text-center text-gray-700 mb-4 mt-6">Yummy Frail Recipes</h2>
        <div class="bg-white p-6 rounded-xl shadow-lg mt-4 max-w-2xl mx-auto">
            <h3 class="text-xl font-semibold text-gray-700 mb-4 text-center">Add New Recipe</h3>
            <div class="flex flex-col gap-4">
                <input type="text" id="yummyFrailRecipeName" placeholder="Recipe Name" class="p-2 border rounded-md focus:ring-2 focus:ring-blue-500 transition duration-200">
                <textarea id="yummyFrailRecipeIngredients" rows="3" placeholder="Ingredients (e.g., Apples:2, Bananas:1)" class="p-2 border rounded-md focus:ring-2 focus:ring-blue-500 transition duration-200"></textarea>
                <button onclick="addRecipe('yummyFrail')" class="bg-blue-600 text-white font-medium px-6 py-2 rounded-md hover:bg-blue-700 transition duration-300 shadow-lg">Add Recipe</button>
            </div>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-lg mt-6 max-w-2xl mx-auto">
            <h3 class="text-xl font-semibold text-gray-700 mb-4 text-center">Available Recipes</h3>
            <div id="yummyFrailRecipes" class="flex flex-col gap-4"></div>
        </div>
    </div>
</main>

<script>
    // Custom message modal functions
    function showMessage(message) {
        document.getElementById('modalContent').innerHTML = message;
        document.getElementById('messageModal').classList.remove('hidden');
    }

    function hideMessage() {
        document.getElementById('messageModal').classList.add('hidden');
    }

    const ADMIN_PASSWORD = "1234";

    const initialStock = {
        yummyCo: { Apples: 50, Bananas: 30, Oranges: 40 },
        keFi: { Apples: 20, Bananas: 40, Oranges: 25 },
        yummyFrail: { Apples: 15, Bananas: 10, Oranges: 20 }
    };
    
    // Initial prices for existing items. New items will have prices set via the admin panel.
    const initialPrices = {
        Apples: 5.50,
        Bananas: 3.30,
        Oranges: 4.40,
    };

    const initialRecipes = {
        yummyCo: [],
        keFi: [],
        yummyFrail: []
    };
    
    // Audit log will now be an array of objects for better data handling
    const initialAuditLog = [];

    // Load state from localStorage
    const stock = JSON.parse(localStorage.getItem('stock')) || JSON.parse(JSON.stringify(initialStock));
    const auditLog = JSON.parse(localStorage.getItem('auditLog')) || initialAuditLog;
    const recipes = JSON.parse(localStorage.getItem('recipes')) || JSON.parse(JSON.stringify(initialRecipes));
    const prices = JSON.parse(localStorage.getItem('prices')) || JSON.parse(JSON.stringify(initialPrices));

    function saveData() {
        localStorage.setItem('stock', JSON.stringify(stock));
        localStorage.setItem('auditLog', JSON.stringify(auditLog));
        localStorage.setItem('recipes', JSON.stringify(recipes));
        localStorage.setItem('prices', JSON.stringify(prices));
    }

    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active-page');
        });
        document.getElementById(pageId).classList.add('active-page');
        
        if (pageId.includes('yummy')) {
            renderRecipes(pageId);
        } else {
            renderKitchens();
        }
    }

    function renderKitchens() {
        const container = document.getElementById('kitchens');
        container.innerHTML = '';
        
        const transferSelect = document.getElementById('item');
        const issueSelect = document.getElementById('issueItem');
        transferSelect.innerHTML = '';
        issueSelect.innerHTML = '';
        const allItems = new Set();

        for (const [key, items] of Object.entries(stock)) {
            let totalValue = 0;
            const kitchenDiv = document.createElement('div');
            kitchenDiv.className = 'kitchen bg-gray-50 rounded-xl p-4 shadow-md w-full sm:w-64';
            let title = key === 'yummyCo' ? 'Yummy Co' : key === 'keFi' ? 'Ke-fi' : 'Yummy Frail';
            let table = `<h3 class="text-center font-bold text-lg mb-2 text-gray-700">${title}</h3><table class="w-full text-sm">`;
            table += `<thead class="bg-gray-200"><tr><th class="p-2 border rounded-tl-md">Item</th><th class="p-2">Stock</th><th class="p-2 rounded-tr-md">Price</th>`;
            if (document.getElementById('adminPanel').classList.contains('active-page')) {
                table += `<th class="p-2">Edit</th><th class="p-2 rounded-tr-md">Remove</th>`;
            }
            table += '</tr></thead>';
            table += '<tbody>';

            for (const [item, qty] of Object.entries(items)) {
                const itemPrice = prices[item] || 0;
                totalValue += qty * itemPrice;
                table += `<tr><td class="p-2 border">${item}</td><td class="p-2 border">${qty}</td><td class="p-2 border">R${itemPrice.toFixed(2)}</td>`;
                if (document.getElementById('adminPanel').classList.contains('active-page')) {
                    table += `<td class="p-2 border"><button onclick="editItem('${key}','${item}')" class="bg-blue-500 text-white px-3 py-1 text-xs rounded hover:bg-blue-600 transition">Edit</button></td>`;
                    table += `<td class="p-2 border"><button onclick="removeItem('${key}','${item}')" class="bg-red-500 text-white px-3 py-1 text-xs rounded hover:bg-red-600 transition">Remove</button></td>`;
                }
                table += '</tr>';
                allItems.add(item);
            }
            table += `</tbody></table>`;
            table += `<div class="mt-2 text-center text-gray-700 font-bold">Total Value: R${totalValue.toFixed(2)}</div>`;
            kitchenDiv.innerHTML = table;
            container.appendChild(kitchenDiv);
        }

        // Populate the transfer and issue dropdowns with all unique items
        transferSelect.innerHTML = [...allItems].map(item => `<option value="${item}">${item}</option>`).join('');
        issueSelect.innerHTML = [...allItems].map(item => `<option value="${item}">${item}</option>`).join('');
        
        renderAuditLog();
    }

    function transferStock() {
        const item = document.getElementById('item').value;
        const from = document.getElementById('from').value;
        const to = document.getElementById('to').value;
        const qty = parseInt(document.getElementById('quantity').value);

        if (from === to) { showMessage('Choose different kitchens.'); return; }
        if (!stock[from] || !stock[from][item]) { showMessage(`${item} does not exist in ${from}.`); return; }
        if (stock[from][item] < qty) { showMessage('Not enough stock.'); return; }

        stock[from][item] -= qty;
        stock[to][item] = (stock[to][item] || 0) + qty;

        auditLog.push({
            timestamp: new Date().toISOString(),
            type: 'transfer',
            item,
            quantity: qty,
            from,
            to,
        });
        saveData();
        renderKitchens();
        showMessage('Stock transferred successfully!');
    }
    
    function issueStock() {
        const item = document.getElementById('issueItem').value;
        const kitchen = document.getElementById('issueFrom').value;
        const qty = parseInt(document.getElementById('issueQuantity').value);
        const invoice = document.getElementById('issueInvoice').value.trim() || null;

        if (!stock[kitchen] || !stock[kitchen][item]) { showMessage(`${item} does not exist in ${kitchen}.`); return; }
        if (stock[kitchen][item] < qty) { showMessage('Not enough stock.'); return; }

        stock[kitchen][item] -= qty;
        
        auditLog.push({
            timestamp: new Date().toISOString(),
            type: 'issue',
            item,
            quantity: qty,
            kitchen,
            invoiceNumber: invoice,
        });
        saveData();
        renderKitchens();
        showMessage('Stock issued successfully!');
    }

    function addItem() {
        const itemName = document.getElementById('newItemName').value.trim();
        const itemPrice = parseFloat(document.getElementById('newItemPrice').value);
        const qty = parseInt(document.getElementById('newItemQty').value);
        const invoice = document.getElementById('newItemInvoice').value.trim() || null;
        const kitchen = document.getElementById('newItemKitchen').value;

        if (!itemName || isNaN(itemPrice) || itemPrice < 0 || isNaN(qty) || qty < 1) { 
            showMessage('Please enter a valid item name, price, and quantity.'); 
            return; 
        }
        
        const oldQty = stock[kitchen][itemName] || 0;
        stock[kitchen][itemName] = oldQty + qty;
        prices[itemName] = itemPrice;

        auditLog.push({
            timestamp: new Date().toISOString(),
            type: 'add',
            item: itemName,
            quantity: qty,
            kitchen,
            invoiceNumber: invoice,
        });
        saveData();
        renderKitchens();
        document.getElementById('newItemName').value = '';
        document.getElementById('newItemPrice').value = '1.00';
        document.getElementById('newItemQty').value = 1;
        document.getElementById('newItemInvoice').value = '';
        showMessage('Item added successfully!');
    }

    function resetStock() {
        const isConfirmed = prompt("Type 'RESET' to confirm resetting all stock to initial values:");
        if (isConfirmed === 'RESET') {
            for (const key in stock) {
                stock[key] = { ...initialStock[key] };
            }
            for (const item in initialPrices) {
                prices[item] = initialPrices[item];
            }
            auditLog.push({
                timestamp: new Date().toISOString(),
                type: 'reset',
                message: 'Stock reset by admin'
            });
            saveData();
            renderKitchens();
            showMessage("Stock has been reset!");
        } else {
            showMessage("Reset cancelled.");
        }
    }

    function loginAdmin() {
        const password = prompt("Enter admin password:");
        if (password === ADMIN_PASSWORD) {
            document.getElementById('adminPanel').classList.add('active-page');
            document.getElementById('adminPanel').classList.remove('hidden');
            renderKitchens();
            showMessage("Admin mode enabled!");
        } else {
            showMessage("Incorrect password!");
        }
    }

    function editItem(kitchen, item) {
        const newQty = parseInt(prompt(`Enter new quantity for ${item} in ${kitchen}:`, stock[kitchen][item]));
        const newPrice = parseFloat(prompt(`Enter new price for ${item}:`, prices[item]));

        if (!isNaN(newQty) && newQty >= 0 && !isNaN(newPrice) && newPrice >= 0) {
            const oldQty = stock[kitchen][item];
            const oldPrice = prices[item];
            stock[kitchen][item] = newQty;
            prices[item] = newPrice;
            auditLog.push({
                timestamp: new Date().toISOString(),
                type: 'edit',
                item,
                kitchen,
                oldQuantity: oldQty,
                newQuantity: newQty,
                oldPrice: oldPrice,
                newPrice: newPrice,
            });
            saveData();
            renderKitchens();
            showMessage("Item updated successfully!");
        } else {
            showMessage("Invalid quantity or price. Edit cancelled.");
        }
    }

    function removeItem(kitchen, item) {
        const isConfirmed = prompt(`Are you sure you want to remove ${item} from ${kitchen}? Type 'REMOVE' to confirm.`);
        if (isConfirmed === 'REMOVE') {
            const oldQty = stock[kitchen][item];
            const oldPrice = prices[item];
            delete stock[kitchen][item];
            delete prices[item];
            auditLog.push({
                timestamp: new Date().toISOString(),
                type: 'remove',
                item,
                kitchen,
                quantity: oldQty,
                price: oldPrice,
            });
            saveData();
            renderKitchens();
            showMessage(`${item} removed successfully.`);
        } else {
            showMessage('Removal cancelled.');
        }
    }

    function renderAuditLog() {
        const container = document.getElementById('auditLog');
        if (!container) return;
        container.innerHTML = auditLog.slice().reverse().map(entry => {
            const date = new Date(entry.timestamp).toLocaleString();
            let logMessage = `${date}: `;
            switch(entry.type) {
                case 'add':
                    logMessage += `Added ${entry.quantity} ${entry.item} to ${entry.kitchen} at R${entry.price.toFixed(2)}. Invoice: ${entry.invoiceNumber || 'N/A'}.`;
                    break;
                case 'transfer':
                    logMessage += `Transferred ${entry.quantity} ${entry.item} from ${entry.from} to ${entry.to}.`;
                    break;
                case 'issue':
                    logMessage += `Issued ${entry.quantity} ${entry.item} from ${entry.kitchen}. Invoice: ${entry.invoiceNumber || 'N/A'}.`;
                    break;
                case 'edit':
                    logMessage += `Edited ${entry.item} in ${entry.kitchen}. Qty: ${entry.oldQuantity} -> ${entry.newQuantity}. Price: R${entry.oldPrice.toFixed(2)} -> R${entry.newPrice.toFixed(2)}.`;
                    break;
                case 'remove':
                    logMessage += `Removed ${entry.item} from ${entry.kitchen}. Old Qty: ${entry.quantity}. Old Price: R${entry.price.toFixed(2)}.`;
                    break;
                case 'reset':
                    logMessage += 'Stock reset by admin.';
                    break;
                default:
                    logMessage += 'Unknown action.';
            }
            return `<div class="p-1 text-sm border-b last:border-b-0 border-gray-200">${logMessage}</div>`;
        }).join('');
    }

    function addRecipe(kitchenId) {
        const recipeName = document.getElementById(`${kitchenId}RecipeName`).value.trim();
        const ingredientsText = document.getElementById(`${kitchenId}RecipeIngredients`).value.trim();
        
        if (!recipeName || !ingredientsText) {
            showMessage('Please enter both a recipe name and ingredients.');
            return;
        }

        const ingredients = {};
        let recipeCost = 0;
        const ingredientLines = ingredientsText.split(',').map(s => s.trim()).filter(s => s);
        let isValid = true;
        
        for (const line of ingredientLines) {
            const parts = line.split(':');
            if (parts.length === 2) {
                const item = parts[0].trim();
                const qty = parseInt(parts[1].trim());
                if (!isNaN(qty) && qty > 0) {
                    ingredients[item] = qty;
                    const itemPrice = prices[item] || 0;
                    recipeCost += itemPrice * qty;
                } else {
                    isValid = false;
                    break;
                }
            } else {
                isValid = false;
                break;
            }
        }

        if (!isValid) {
            showMessage('Invalid ingredients format. Please use "Item:Quantity, Item2:Quantity2".');
            return;
        }

        recipes[kitchenId].push({ name: recipeName, ingredients, cost: recipeCost.toFixed(2) });
        saveData();
        renderRecipes(kitchenId);
        document.getElementById(`${kitchenId}RecipeName`).value = '';
        document.getElementById(`${kitchenId}RecipeIngredients`).value = '';
        showMessage(`Recipe "${recipeName}" added to ${kitchenId}.`);
    }

    function renderRecipes(kitchenId) {
        const container = document.getElementById(`${kitchenId}Recipes`);
        container.innerHTML = '';

        if (recipes[kitchenId].length === 0) {
            container.innerHTML = `<p class="text-center text-gray-500 italic">No recipes added yet.</p>`;
            return;
        }

        recipes[kitchenId].forEach((recipe, index) => {
            const recipeDiv = document.createElement('div');
            recipeDiv.className = 'bg-gray-50 p-4 rounded-lg shadow-md';
            
            const ingredientsList = Object.entries(recipe.ingredients).map(([item, qty]) => {
                const stockQty = stock[kitchenId][item] || 0;
                const isAvailable = stockQty >= qty;
                const color = isAvailable ? 'text-green-600' : 'text-red-600';
                const itemPrice = prices[item] || 0;
                const itemCost = (itemPrice * qty).toFixed(2);
                return `<li class="${color} flex justify-between items-center"><span class="font-medium">${item}:</span> <span>${qty} (Stock: ${stockQty}) - R${itemCost}</span></li>`;
            }).join('');
            
            let canMakeRecipe = true;
            for(const [item, requiredQty] of Object.entries(recipe.ingredients)) {
                if((stock[kitchenId][item] || 0) < requiredQty) {
                    canMakeRecipe = false;
                    break;
                }
            }
            const availabilityMessage = canMakeRecipe ? '✅ You can make this!' : '❌ Not enough stock!';

            recipeDiv.innerHTML = `
                <div class="flex flex-col sm:flex-row justify-between items-center mb-2">
                    <h4 class="text-lg font-semibold text-gray-700">${recipe.name}</h4>
                    <span class="text-gray-600 font-medium">Cost: R${recipe.cost}</span>
                </div>
                <ul class="list-disc list-inside space-y-1">
                    ${ingredientsList}
                </ul>
                <div class="mt-4 font-bold text-center">${availabilityMessage}</div>
                <div class="flex justify-end mt-4">
                    <button onclick="deleteRecipe('${kitchenId}', ${index})" class="bg-red-500 text-white px-3 py-1 rounded-md text-sm hover:bg-red-600 transition duration-300">Delete</button>
                </div>
            `;
            container.appendChild(recipeDiv);
        });
    }

    function deleteRecipe(kitchenId, recipeIndex) {
        const recipeName = recipes[kitchenId][recipeIndex].name;
        recipes[kitchenId].splice(recipeIndex, 1);
        saveData();
        renderRecipes(kitchenId);
        showMessage(`Recipe "${recipeName}" deleted.`);
    }

    function generateIssuedReport() {
        const period = document.getElementById('reportPeriod').value;
        const reportContainer = document.getElementById('issuedReport');
        reportContainer.innerHTML = '';

        let startDate = new Date();
        const now = new Date();
        
        switch(period) {
            case 'daily':
                startDate.setDate(now.getDate() - 1); // Last 24 hours
                break;
            case 'weekly':
                startDate.setDate(now.getDate() - 7); // Last 7 days
                break;
            case 'monthly':
                startDate.setMonth(now.getMonth() - 1); // Last 30 days
                break;
        }

        const issuedItems = {};

        auditLog.forEach(entry => {
            if (entry.type === 'issue' && new Date(entry.timestamp) >= startDate) {
                const item = entry.item;
                issuedItems[item] = (issuedItems[item] || 0) + entry.quantity;
            }
        });
        
        if (Object.keys(issuedItems).length === 0) {
            reportContainer.innerHTML = `<p class="text-center text-gray-500 italic">No stock was issued in the selected period.</p>`;
        } else {
            let reportHtml = `<p class="text-center font-bold mb-2">Total Stock Issued (${period}):</p>`;
            reportHtml += `<ul class="list-disc list-inside space-y-1">`;
            for (const item in issuedItems) {
                reportHtml += `<li class="font-medium">${item}: <span class="text-gray-600">${issuedItems[item]}</span></li>`;
            }
            reportHtml += `</ul>`;
            reportContainer.innerHTML = reportHtml;
        }

        reportContainer.classList.remove('hidden');
    }

    // Initial render
    window.onload = function() {
        renderKitchens();
        showPage('home');
    }
</script>
</body>
</html>
