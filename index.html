<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Kitchen Stock Manager</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-7xl mx-auto">
    <h1 class="text-3xl font-bold mb-4 text-center">Kitchen Stock Manager</h1>

    <!-- Top nav / tabs -->
    <div class="flex flex-wrap gap-2 justify-center mb-6">
      <button class="tab-btn px-4 py-2 bg-indigo-600 text-white rounded" data-target="storeRoom">Store Room</button>
      <button class="tab-btn px-4 py-2 bg-gray-200 rounded" data-target="frail">Kitchen 1 - Frail</button>
      <button class="tab-btn px-4 py-2 bg-gray-200 rounded" data-target="catering">Kitchen 2 - Catering</button>
      <button class="tab-btn px-4 py-2 bg-gray-200 rounded" data-target="kefi">Kitchen 3 - Kefi</button>
      <button class="tab-btn px-4 py-2 bg-gray-200 rounded" data-target="frailFoh">Kitchen 4 - Frail FOH</button>
    </div>

    <div id="content" class="space-y-6">
      <!-- Store Room -->
      <div id="storeRoom" class="page bg-white p-4 rounded-lg shadow">
        <h2 class="font-semibold mb-2">Store Room (Master Stock)</h2>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <h3 class="font-medium mb-2">Add / Update Stock</h3>
            <div class="flex gap-2">
              <input id="srItem" placeholder="Item" class="flex-1 p-2 border rounded" />
              <input id="srQty" type="number" placeholder="Qty" class="w-28 p-2 border rounded" />
              <input id="srPrice" type="number" step="0.01" placeholder="Price (R)" class="w-28 p-2 border rounded" />
              <button id="srAdd" class="bg-green-600 text-white px-4 rounded">Add</button>
            </div>
          </div>
          <div>
            <h3 class="font-medium mb-2">Store Room Stock</h3>
            <ul id="srList" class="list-disc pl-6 space-y-1 max-h-48 overflow-auto"></ul>
            <h3 class="font-medium mt-4 mb-2">Shopping List (Low Stock &lt;3)</h3>
            <ul id="shoppingList" class="list-disc pl-6 space-y-1 max-h-40 overflow-auto text-red-600"></ul>
          </div>
        </div>
      </div>

      <!-- Other kitchens placeholders -->
      <div id="frail" class="page hidden bg-white p-4 rounded-lg shadow"></div>
      <div id="catering" class="page hidden bg-white p-4 rounded-lg shadow"></div>
      <div id="kefi" class="page hidden bg-white p-4 rounded-lg shadow"></div>
      <div id="frailFoh" class="page hidden bg-white p-4 rounded-lg shadow"></div>
    </div>
  </div>

  <!-- Firebase modular SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    // TODO: Replace with your own Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDywp4wU8oiDypiQ5OydSfQuyx8xS2BerQ",
      authDomain: "kitchen-stock-44799.firebaseapp.com",
      projectId: "kitchen-stock-44799",
      storageBucket: "kitchen-stock-44799.firebasestorage.app",
      messagingSenderId: "320520731433",
      appId: "1:320520731433:web:a69d9bc6fc1cb3959f5538",
      measurementId: "G-11Q1S857RR"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const LOCATIONS = ['storeRoom','frail','catering','kefi','frailFoh'];
    let stock = { storeRoom: {}, frail: {}, catering: {}, kefi: {}, frailFoh: {} };
    let prices = {};

    function $(id){return document.getElementById(id);}
    
    // Tabs
    document.querySelectorAll('.tab-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const target = btn.dataset.target;
        document.querySelectorAll('.page').forEach(p=>p.classList.add('hidden'));
        $(target).classList.remove('hidden');
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('bg-indigo-600','text-white'));
        btn.classList.add('bg-indigo-600','text-white');
      });
    });

    // Add Store Room stock
    $('srAdd').addEventListener('click', async ()=>{
      const item = $('srItem').value.trim();
      const qty = parseFloat($('srQty').value);
      const price = parseFloat($('srPrice').value);
      if(!item || isNaN(qty) || isNaN(price)) return alert('Enter item, qty, price');
      stock.storeRoom[item] = (stock.storeRoom[item] || 0) + qty;
      prices[item] = price;
      await setDoc(doc(db,'stock','storeRoom'), stock.storeRoom);
      $('srItem').value=''; $('srQty').value=''; $('srPrice').value='';
    });

    // Listen to storeRoom stock changes
    const srRef = doc(db,'stock','storeRoom');
    onSnapshot(srRef, (docSnap)=>{
      if(docSnap.exists()){
        stock.storeRoom = docSnap.data();
        renderStoreRoom();
      }
    });

    function renderStoreRoom(){
      const container = $('srList');
      const shopping = $('shoppingList');
      container.innerHTML = '';
      shopping.innerHTML = '';
      for(const [item,qty] of Object.entries(stock.storeRoom)){
        container.innerHTML += `<li>${item}: ${qty} — R${prices[item] ? prices[item].toFixed(2) : '0.00'}</li>`;
        if(qty < 3) shopping.innerHTML += `<li>${item}: ${qty}</li>`;
      }
    }

    // Show Store Room by default
    document.querySelectorAll('.tab-btn')[0].click();
  </script>
</body>
</html>
<script type="module">
// --- continuing from Part 1 ---
import { doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

// Helper to render kitchen stock
function renderKitchen(kitchen) {
  const container = $(kitchen + 'List');
  if (!container) return;
  container.innerHTML = '';
  for (const [item, qty] of Object.entries(stock[kitchen])) {
    container.innerHTML += `<li>${item}: ${qty} — R${prices[item] ? prices[item].toFixed(2) : '0.00'}</li>`;
  }
}

// Initialize kitchens
['frail','catering','kefi','frailFoh'].forEach(kitchen => {
  const page = $(kitchen);
  const listId = kitchen + 'List';
  page.innerHTML = `
    <h2 class="font-semibold mb-2">${kitchen.toUpperCase()} Stock</h2>
    <div class="grid md:grid-cols-2 gap-4">
      <div>
        <h3 class="font-medium mb-2">Transfer from Store Room</h3>
        <div class="flex gap-2">
          <select id="${kitchen}Item" class="flex-1 p-2 border rounded">
            <option value="">Select Item</option>
          </select>
          <input id="${kitchen}Qty" type="number" placeholder="Qty" class="w-28 p-2 border rounded" />
          <button id="${kitchen}Add" class="bg-green-600 text-white px-4 rounded">Add</button>
        </div>
      </div>
      <div>
        <h3 class="font-medium mb-2">Current Stock</h3>
        <ul id="${listId}" class="list-disc pl-6 space-y-1 max-h-48 overflow-auto"></ul>
      </div>
    </div>
  `;

  // Update item select options when storeRoom changes
  onSnapshot(doc(db,'stock','storeRoom'), docSnap => {
    const select = $(kitchen + 'Item');
    if (docSnap.exists()) {
      const srStock = docSnap.data();
      select.innerHTML = '<option value="">Select Item</option>';
      for (const item of Object.keys(srStock)) {
        select.innerHTML += `<option value="${item}">${item} (${srStock[item]})</option>`;
      }
    }
  });

  // Add/transfer stock from Store Room
  $(kitchen+'Add').addEventListener('click', async ()=>{
    const item = $(kitchen+'Item').value;
    const qty = parseFloat($(kitchen+'Qty').value);
    if (!item || isNaN(qty) || qty <= 0) return alert('Select item and enter qty');

    if ((stock.storeRoom[item] || 0) < qty) return alert('Not enough stock in Store Room');

    // Deduct from Store Room
    stock.storeRoom[item] -= qty;
    await setDoc(doc(db,'stock','storeRoom'), stock.storeRoom);

    // Add to kitchen
    stock[kitchen][item] = (stock[kitchen][item] || 0) + qty;
    await setDoc(doc(db,'stock',kitchen), stock[kitchen]);

    $(kitchen+'Qty').value = '';
  });

  // Listen to kitchen stock changes
  onSnapshot(doc(db,'stock',kitchen), docSnap => {
    if (docSnap.exists()){
      stock[kitchen] = docSnap.data();
      renderKitchen(kitchen);
    }
  });
});
</script>
<script type="module">
// --- Low Stock & Shopping List ---

// Threshold for low stock alert
const LOW_STOCK_THRESHOLD = 3; // less than 3 items

// Container for shopping list
const shoppingContainer = document.createElement('div');
shoppingContainer.className = 'bg-yellow-50 p-4 rounded mb-6';
shoppingContainer.innerHTML = `<h2 class="font-semibold mb-2">Shopping List (Low Stock)</h2>
<ul id="shoppingList" class="list-disc pl-6 space-y-1"></ul>`;
document.body.prepend(shoppingContainer);

// Function to check low stock and build shopping list
function updateShoppingList() {
  const allItems = {}; // item: total qty across kitchens
  const listEl = document.getElementById('shoppingList');
  listEl.innerHTML = '';

  // Sum all kitchen stocks
  ['frail','catering','kefi','frailFoh'].forEach(k=>{
    for (const [item, qty] of Object.entries(stock[k] || {})){
      allItems[item] = (allItems[item] || 0) + qty;
    }
  });

  // Check Store Room items too
  for (const [item, qty] of Object.entries(stock.storeRoom || {})){
    allItems[item] = (allItems[item] || 0) + qty;
  }

  // Filter low stock items
  const lowStockItems = Object.entries(allItems).filter(([item, qty]) => qty < LOW_STOCK_THRESHOLD);

  if(lowStockItems.length === 0){
    listEl.innerHTML = '<li>All stocks sufficient</li>';
    return;
  }

  // Render low stock items
  lowStockItems.forEach(([item, qty])=>{
    const li = document.createElement('li');
    li.textContent = `${item}: ${qty} in stock — need to order`;
    li.className = 'text-red-600';
    listEl.appendChild(li);
  });
}

// Run every time stock changes
['storeRoom','frail','catering','kefi','frailFoh'].forEach(loc=>{
  onSnapshot(doc(db,'stock',loc), docSnap=>{
    if(docSnap.exists()) {
      stock[loc] = docSnap.data();
      updateShoppingList();
    }
  });
});
</script>
<script type="module">
// --- Part 4: Low Stock Notification & Shopping List Export ---

import { doc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

// Container already created in Part 3
const shoppingExportBtn = document.createElement('button');
shoppingExportBtn.textContent = 'Export Shopping List CSV';
shoppingExportBtn.className = 'bg-green-600 text-white px-4 py-2 rounded mt-2';
shoppingContainer.appendChild(shoppingExportBtn);

shoppingExportBtn.addEventListener('click', () => {
    const listItems = Array.from(document.querySelectorAll('#shoppingList li'))
        .filter(li => li.textContent.includes('need to order'))
        .map(li => li.textContent.replace(' in stock — need to order',''));
    
    if(listItems.length === 0){
        alert('No low-stock items to export.');
        return;
    }

    const csvContent = 'Item,Current Qty\n' + listItems.map(item=>{
        const qty = Object.entries(stock).reduce((sum, [loc, items]) => sum + (items[item] || 0), 0);
        return `${item},${qty}`;
    }).join('\n');

    const blob = new Blob([csvContent], {type: 'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'shopping_list.csv';
    a.click();
    URL.revokeObjectURL(url);
});

// Optional: show a browser alert when any item drops below threshold
function checkLowStockNotification() {
    const lowItems = [];
    for(const loc of ['storeRoom','frail','catering','kefi','frailFoh']){
        for(const [item,qty] of Object.entries(stock[loc] || {})){
            if(qty < LOW_STOCK_THRESHOLD) lowItems.push(`${item} (${qty})`);
        }
    }
    if(lowItems.length) alert('Low Stock Alert:\n' + lowItems.join('\n'));
}

// Run every time stock changes
['storeRoom','frail','catering','kefi','frailFoh'].forEach(loc=>{
    onSnapshot(doc(db,'stock',loc), docSnap=>{
        if(docSnap.exists()) {
            stock[loc] = docSnap.data();
            updateShoppingList();
            checkLowStockNotification();
        }
    });
});
</script>
