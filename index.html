<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Kitchen Stock Manager (Firebase Modular)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
<div class="max-w-7xl mx-auto">

  <h1 class="text-3xl font-bold mb-4 text-center">Kitchen Stock Manager — Firebase Modular</h1>

  <!-- Top nav / tabs -->
  <div class="flex flex-wrap gap-2 justify-center mb-6">
    <button class="tab-btn px-4 py-2 bg-indigo-600 text-white rounded" data-target="storeRoom">Store Room</button>
    <button class="tab-btn px-4 py-2 bg-gray-200 rounded" data-target="frail">Kitchen 1 - Frail</button>
    <button class="tab-btn px-4 py-2 bg-gray-200 rounded" data-target="catering">Kitchen 2 - Catering</button>
    <button class="tab-btn px-4 py-2 bg-gray-200 rounded" data-target="kefi">Kitchen 3 - Kefi</button>
    <button class="tab-btn px-4 py-2 bg-gray-200 rounded" data-target="frailFoh">Kitchen 4 - Frail FOH</button>
  </div>

  <div id="content" class="space-y-6">
    <!-- Low stock / shopping list -->
    <div class="bg-white p-4 rounded-lg shadow">
      <h2 class="font-semibold mb-2">Low Stock & Shopping List</h2>
      <ul id="lowStockList" class="list-disc pl-6 space-y-1 text-red-600"></ul>
    </div>

    <!-- TRANSFER PANEL -->
    <div class="bg-white p-4 rounded-lg shadow">
      <h2 class="font-semibold mb-2">Transfer Stock</h2>
      <div class="grid grid-cols-1 md:grid-cols-5 gap-2 items-end">
        <div>
          <label class="text-sm font-medium">From</label>
          <select id="transferFrom" class="w-full p-2 border rounded"></select>
        </div>
        <div>
          <label class="text-sm font-medium">To</label>
          <select id="transferTo" class="w-full p-2 border rounded"></select>
        </div>
        <div>
          <label class="text-sm font-medium">Item</label>
          <input id="transferItem" class="w-full p-2 border rounded" placeholder="Item name" />
        </div>
        <div>
          <label class="text-sm font-medium">Quantity</label>
          <input id="transferQty" type="number" min="1" value="1" class="w-full p-2 border rounded" />
        </div>
        <div>
          <button id="transferBtn" class="w-full bg-blue-600 text-white px-4 py-2 rounded">Transfer</button>
        </div>
      </div>
      <p id="transferMessage" class="text-sm mt-2 text-gray-600"></p>
    </div>

    <!-- Store Room -->
    <div id="storeRoom" class="page bg-white p-4 rounded-lg shadow">
      <h2 class="font-semibold mb-2">Store Room (Master Stock)</h2>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <h3 class="font-medium mb-2">Add / Update Stock</h3>
          <div class="flex gap-2">
            <input id="srItem" placeholder="Item" class="flex-1 p-2 border rounded" />
            <input id="srQty" type="number" placeholder="Qty" class="w-28 p-2 border rounded" />
            <input id="srPrice" type="number" step="0.01" placeholder="Price (R)" class="w-28 p-2 border rounded" />
            <button id="srAdd" class="bg-green-600 text-white px-4 rounded">Add</button>
          </div>
        </div>
        <div>
          <h3 class="font-medium mb-2">Store Room Stock</h3>
          <ul id="srList" class="list-disc pl-6 space-y-1 max-h-48 overflow-auto"></ul>
        </div>
      </div>
    </div>

    <!-- Kitchens (frail, catering, kefi, frailFoh) -->
    <!-- We'll only show frail template here; replicate for others if needed -->
    <div id="frail" class="page hidden bg-white p-4 rounded-lg shadow">
      <h2 class="font-semibold mb-2">Kitchen 1 — Frail</h2>
      <div class="grid md:grid-cols-3 gap-4">
        <!-- Stock -->
        <div>
          <h3 class="font-medium mb-2">Stock</h3>
          <div class="flex gap-2 mb-2">
            <input id="frailItem" placeholder="Item" class="flex-1 p-2 border rounded" />
            <input id="frailQty" type="number" placeholder="Qty" class="w-28 p-2 border rounded" />
            <input id="frailPrice" type="number" step="0.01" placeholder="Price (R)" class="w-28 p-2 border rounded" />
            <button data-add="frail" class="bg-green-600 text-white px-3 rounded">Add</button>
          </div>
          <ul id="frailStock" class="list-disc pl-6 space-y-1 max-h-40 overflow-auto"></ul>
        </div>
        <!-- Recipes -->
        <div>
          <h3 class="font-medium mb-2">Recipes</h3>
          <input id="frailRecipeName" placeholder="Recipe name" class="w-full p-2 border rounded mb-2" />
          <textarea id="frailRecipeIngredients" placeholder="item:qty per line" class="w-full p-2 border rounded h-28 mb-2"></textarea>
          <div class="flex gap-2 mb-2">
            <button data-recipe-add="frail" class="bg-blue-600 text-white px-3 rounded">Add Recipe</button>
            <input id="frailCsv" type="file" accept=".csv" class="text-sm" />
            <button data-csv="frail" class="bg-orange-500 text-white px-3 rounded">Upload CSV</button>
          </div>
          <div id="frailRecipes" class="space-y-2 max-h-48 overflow-auto"></div>
        </div>
        <!-- Menu & Prep -->
        <div>
          <h3 class="font-medium mb-2">Menu & Prep</h3>
          <div class="flex gap-2 mb-2">
            <select id="frailRecipeSelect" class="flex-1 p-2 border rounded"></select>
            <input id="frailPortions" type="number" min="1" value="1" class="w-28 p-2 border rounded" />
            <button data-addmenu="frail" class="bg-purple-600 text-white px-3 rounded">Add to Menu</button>
          </div>
          <ul id="frailMenu" class="list-disc pl-6 space-y-1 mb-2 max-h-40 overflow-auto"></ul>
          <button data-genprep="frail" class="bg-amber-500 text-white px-4 py-2 rounded w-full mb-2">Generate & Save Prep List</button>
          <div id="frailPrepHistory" class="space-y-2 max-h-40 overflow-auto"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Firebase Modular SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getFirestore, doc, collection, setDoc, getDoc, onSnapshot, runTransaction, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

// ----------------- Firebase Config -----------------
const firebaseConfig = {
  apiKey: "AIzaSyDywp4wU8oiDypiQ5OydSfQuyx8xS2BerQ",
  authDomain: "kitchen-stock-44799.firebaseapp.com",
  projectId: "kitchen-stock-44799",
  storageBucket: "kitchen-stock-44799.firebasestorage.app",
  messagingSenderId: "320520731433",
  appId: "1:320520731433:web:a69d9bc6fc1cb3959f5538",
  measurementId: "G-11Q1S857RR"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ----------------- Locations -----------------
const LOCATIONS = ['storeRoom','frail','catering','kefi','frailFoh'];
let stock = { storeRoom:{}, frail:{}, catering:{}, kefi:{}, frailFoh:{} };
let prices = {};
let recipes = { frail:[], catering:[], kefi:[], frailFoh:[] };
let menu = { frail:[], catering:[], kefi:[], frailFoh:[] };
const LOW_STOCK_THRESHOLD = 5; // alert if qty < 5

function $(id){ return document.getElementById(id); }

// ----------------- Transfer dropdowns -----------------
function populateTransferOptions(){
  const from = $('transferFrom');
  const to = $('transferTo');
  from.innerHTML = LOCATIONS.map(l=>`<option value="${l}">${locationLabel(l)}</option>`).join('');
  to.innerHTML = LOCATIONS.map(l=>`<option value="${l}">${locationLabel(l)}</option>`).join('');
}
function locationLabel(id){
  switch(id){
    case 'storeRoom': return 'Store Room';
    case 'frail': return 'Kitchen 1 - Frail';
    case 'catering': return 'Kitchen 2 - Catering';
    case 'kefi': return 'Kitchen 3 - Kefi';
    case 'frailFoh': return '
